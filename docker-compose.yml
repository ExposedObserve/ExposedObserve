version: '3.8'

services:
  exposedobserve:
    image: exposedobserve:local
    ports:
      - "5080:5080"
    extra_hosts:
      - "localhost:host-gateway"
    volumes:
      - ./data:/data
    environment:
      - ZO_ROOT_USER_EMAIL=root@example.com
      - ZO_ROOT_USER_PASSWORD=Complexpass#123
      - ZO_MAX_FILE_SIZE_ON_DISK=32
      - ZO_FILE_PUSH_INTERVAL=10
      - ZO_LOCAL_MODE=true
      - ZO_DATA_DIR=/data
      - OIDC_ISSUER_URL=http://localhost:8080/default
      - OIDC_REVOCATION_URL=http://localhost:8080/default/revoke
      - OIDC_CLIENT_ID=default
      - OIDC_CLIENT_SECRET=oauth2-test-secret
      - OIDC_REDIRECT_URL=http://localhost:5080/auth/callback
      - OIDC_INSECURE=true
      - OIDC_ORG_CLAIM=group
      - OIDC_COOKIE_MAX_AGE_SEC=60
      - OIDC_CALLBACK_URL=http://localhost:5080/web/cb
    depends_on:
      - mock-oauth2-server
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5080/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  mock-oauth2-server:
    image: ghcr.io/navikt/mock-oauth2-server:3.0.0
    ports:
      - "8080:8080"
    environment:
      - SERVER_PORT=8080
      - JSON_CONFIG_PATH=/config/config.json
    volumes:
      - ./docker/mock-oauth2-config.json:/config/config.json
    restart: unless-stopped
